<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Index of Indexes Search</title>
  <link rel="icon" href="QARA.png" type="image/png"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>

  <style>
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      width: 100vw;
      height: 100vh;
      background-color: black;
    }
    .banner {
      display: flex;
      align-items: center;
      background-color: white;
      font-size: 24px;
      font-weight: bold;
      color: red;
      margin: 0 auto 20px;
      width: 100%;
      max-width: 700px;
      height: 60px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .banner img { height: 100%; margin-left: 0; margin-right: 10px; }
    .banner-text { flex-grow: 1; text-align: center; margin-right: 40px; }
    .container { padding: 0; margin: 10px; text-align: center; }
    .table-container { width: 100%; overflow-x: auto; }
    table { width: 100%; table-layout: auto; border-collapse: collapse; }
    th, td {
      padding: 10px; text-align: left; border: 1px solid #ddd;
      vertical-align: top; overflow: hidden;
    }
    tr:nth-child(even) { background-color: #e6f2ff; }
    tr:nth-child(odd) { background-color: #ffffff; }
    th:nth-child(1), td:nth-child(1) { width: 100px; white-space: nowrap; }
    th:nth-child(2), td:nth-child(2) { width: 1%; white-space: nowrap; }
    th:nth-child(3), td:nth-child(3) { white-space: normal; word-wrap: break-word; }
    th:nth-child(4), td:nth-child(4) { white-space: nowrap; width: 1%; }
    th:nth-child(5), td:nth-child(5) { white-space: normal; line-height: 1.2em; text-align: left; vertical-align: top; }
    .filter-select, #searchInput, .select2-container { width: 100%; font-family: inherit; font-size: 14px; }
    .select2-container--default .select2-selection--single .select2-selection__rendered,
    .select2-selection__choice { font-weight: normal !important; font-size: 12px !important; }
    .select2-dropdown .select2-results__options { font-size: 12px; }
    .main-title span { font-size: 24px; font-weight: bold; }
    .main-title span.blue { color: #0778AB; }
    .main-title span:not(.blue) { color: #FBBB6A; }
    h1 { font-size: 24px; font-weight: bold; text-align: center; margin-top: 0px; color: white; }
    .copilot-link { text-decoration: underline; }

    @media screen and (max-width: 600px) {
      th:nth-child(3), td:nth-child(3),
      th:nth-child(4), td:nth-child(4) { display: none; }
      th, td { font-size: 12px; padding: 6px; }
      .filter-select, #searchInput, .select2-selection { font-size: 12px; }
      table { width: 100%; }
      h1 { font-size: 18px; }
    }
  </style>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>

<body style="background-color: black;">
  <div class="container">
    <div class="banner">
      <img src="Swissflag.png" alt="Swiss Flag">
      <div class="banner-text">REGULATORY ROUNDUP</div>
    </div>
    <div class="main-title"><span>MedTech </span><span class="blue">Leading</span> <span>Voice</span></div>
    <h1>Regulatory Roundup Index Search <span id="entryCount"></span></h1>
  </div>

  <div class="table-container">
    <table id="csvTable">
      <thead>
        <tr>
          <th>CoPilot</th>
          <th id="dateColumn">Date
            <div><select id="dateFilter" class="filter-select" multiple onchange="filterTable(); saveState();"></select></div>
          </th>
          <th>Agency
            <div><select id="agencyFilter" class="filter-select" onchange="filterTable(); saveState();"></select></div>
          </th>
          <th>Category
            <div><select id="categoryFilter" class="filter-select" onchange="filterTable(); saveState();"></select></div>
          </th>
          <th>Title
            <div><input type="text" id="searchInput" class="filter-select" onkeyup="filterTable(); saveState();" placeholder="Keyword Search Title.."></div>
          </th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    // ========= ADD/REMOVE YOUR CSVs HERE =========
    const CSV_SOURCES = [
      'https://martincking.github.io/Index-of-Indexes/Index of Indexes 2025.csv',
      'https://martincking.github.io/Index-of-Indexes/Index of Indexes 2024.csv'
    ];
    const URL_MAP_FILE   = 'https://martincking.github.io/Index-of-Indexes/URL.csv';
    const AGENCY_MAP_FILE = 'https://martincking.github.io/Index-of-Indexes/Agencies.csv';

    let tableData = [];
    let dateURLMapping = {};
    let agencyURLMapping = {};

    // --- State persistence keys
    const STATE_KEY = 'rr_state_v2';

    // Helpers
    const norm = s => String(s || '').toLowerCase().replace(/\s+/g,'');
    const looksLikeHeader = row =>
      row && row.length >= 4 &&
      norm(row[0]).includes('date') &&
      norm(row[1]).includes('agency');

    const normAgency = s => String(s || '').trim().replace(/\s+/g,' ').toUpperCase();

    function loadCSVFiles() {
      fetch(encodeURI(`${AGENCY_MAP_FILE}?t=${Date.now()}`))
        .then(res => res.text())
        .then(text => {
          Papa.parse(text, {
            complete: results => {
              results.data.forEach((row, i) => {
                if (i === 0 && String(row[0]).toLowerCase().includes('agency')) return;
                const key = normAgency(row[0]);
                const url = (row[1] || '').trim();
                if (key && url) agencyURLMapping[key] = url;
              });
            },
            skipEmptyLines: true
          });
        })
        .catch(() => {})
        .finally(() => {
          fetch(encodeURI(`${URL_MAP_FILE}?t=${Date.now()}`))
            .then(res => res.text())
            .then(text => {
              Papa.parse(text, {
                complete: results => {
                  results.data.forEach((row, i) => {
                    if (i === 0 && String(row[0]).toLowerCase().includes('date')) return;
                    const date = (row[0] == null) ? '' : String(row[0]);
                    const url  = (row[1] || '').trim();
                    if (date && url) dateURLMapping[date] = url;
                  });
                  fetchAndCombineDataCSVs();
                },
                skipEmptyLines: true
              });
            })
            .catch(() => fetchAndCombineDataCSVs());
        });
    }

    function fetchAndCombineDataCSVs() {
      Promise.all(
        CSV_SOURCES.map(src => fetch(encodeURI(src)).then(r => r.text()))
      ).then(texts => {
        let merged = [];
        texts.forEach(txt => {
          const parsed = Papa.parse(txt, { skipEmptyLines: true }).data;
          const rowsOnly = (parsed.length && looksLikeHeader(parsed[0])) ? parsed.slice(1) : parsed;
          rowsOnly.forEach(r => {
            if (!r || r.every(cell => !cell)) return;
            const date     = (r[0] == null) ? '' : String(r[0]);
            const agency   = (r[1] || '').trim();
            const category = (r[2] || '').trim();
            const title    = (r[3] || '').trim();
            const link     = (r[4] || '').trim();
            if (date || agency || category || title) merged.push([date, agency, category, title, link]);
          });
        });
        tableData = merged;
        renderTable(tableData);
        populateFilters(tableData);
        adjustDateColumnWidth(tableData);
        setTimeout(() => { restoreState(); applyURLFilters(); }, 100);
      });
    }

    function renderTable(data) {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = data.map(row => {
        const [date, agency, category, title, link] = row;

        const titleLink = (link && /^https?:\/\//i.test(link))
          ? `<a href="${link}" target="_blank" rel="noopener">${title || link}</a>`
          : title;

        const dateLink = dateURLMapping[date];
        const aUrl = agencyURLMapping[normAgency(agency)];

        // Build Copilot link (anchor we intercept)
        const query = encodeURIComponent([agency, category, title].filter(Boolean).join(' '));
        const copilot = `<a href="https://www.bing.com/search?q=${query}&showconv=1" 
                            class="copilot-link" 
                            data-q="${query}" 
                            rel="noopener noreferrer"
                            target="_blank">Copilot</a>`;

        return `<tr>
          <td>${copilot}</td>
          <td>${dateLink ? `<a href="${dateLink}" target="_blank" rel="noopener">${date}</a>` : date}</td>
          <td>${aUrl ? `<b><a href="${aUrl}" target="_blank" rel="noopener">${agency}</a></b>` : `<b>${agency}</b>`}</td>
          <td><b>${category}</b></td>
          <td>${titleLink}</td>
        </tr>`;
      }).join('');
      document.getElementById('entryCount').textContent = `(${data.length.toLocaleString()} entries)`;
    }

    function filterTable() {
      const selectedDates = $('#dateFilter').val() || [],
            agency = (document.getElementById('agencyFilter').value || '').toUpperCase(),
            category = (document.getElementById('categoryFilter').value || '').toUpperCase(),
            titleSearch = (document.getElementById('searchInput').value || '').toUpperCase();

      const filtered = tableData.filter(row => {
        const [date, a, c, t] = row;
        return (!selectedDates.length || selectedDates.includes(date)) &&
               (!agency || (a || '').toUpperCase() === agency) &&
               (!category || (c || '').toUpperCase() === category) &&
               (!titleSearch || (t || '').toUpperCase().includes(titleSearch));
      });
      renderTable(filtered);
    }

    // --- Save/restore UI state (filters + scroll)
    function saveState() {
      try {
        const state = {
          dates: $('#dateFilter').val() || [],
          agency: document.getElementById('agencyFilter').value || '',
          category: document.getElementById('categoryFilter').value || '',
          title: document.getElementById('searchInput').value || '',
          scrollY: window.scrollY || 0
        };
        localStorage.setItem(STATE_KEY, JSON.stringify(state));
      } catch(e) {}
    }

    function restoreState() {
      try {
        const raw = localStorage.getItem(STATE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (s.dates && s.dates.length) $('#dateFilter').val(s.dates).trigger('change');
        if (s.agency)   $('#agencyFilter').val(s.agency).trigger('change');
        if (s.category) $('#categoryFilter').val(s.category).trigger('change');
        if (s.title)    document.getElementById('searchInput').value = s.title;
        filterTable();
        if (typeof s.scrollY === 'number') window.scrollTo(0, s.scrollY);
      } catch(e) {}
    }

    function populateFilters(data) {
      const dateSet = new Set(), agencySet = new Set(), categorySet = new Set();
      data.forEach(row => {
        const [date, agency, category] = row;
        if (date) dateSet.add(date);
        if (agency) agencySet.add(agency);
        if (category) categorySet.add(category);
      });
      createDropdown('dateFilter', [...dateSet], true);
      createDropdown('agencyFilter', [...agencySet].sort());
      createDropdown('categoryFilter', [...categorySet].sort());
    }

    function createDropdown(id, items, multiple = false) {
      const el = document.getElementById(id);
      el.innerHTML = multiple ? '' : `<option value="">Select ${id.replace('Filter','')}</option>`;
      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = item;
        el.appendChild(opt);
      });
      $(`#${id}`).val(null).select2({
        placeholder: `Select ${id.replace('Filter','')}`,
        allowClear: true,
        multiple,
        width: '100%'
      });
    }

    function adjustDateColumnWidth(data) {
      const col = document.getElementById('dateColumn');
      const max = data.reduce((a, b) => (String(a[0]||'').length > String(b[0]||'').length ? a : b), ['']);
      col.style.width = `${String(max[0]||'').length * 10}px`;
    }

    function getQueryParams() {
      return Object.fromEntries(new URLSearchParams(window.location.search).entries());
    }

    function applyURLFilters() {
      const params = getQueryParams();
      if (params.date) {
        const raw = params.date.split(',');
        $('#dateFilter').val(raw).trigger('change');
      }
      if (params.agency)   $('#agencyFilter').val(params.agency).trigger('change');
      if (params.category) $('#categoryFilter').val(params.category).trigger('change');
      if (params.title || params.search)
        document.getElementById('searchInput').value = params.title || params.search;

      filterTable();
    }

    // Intercept Copilot clicks: save state, try to open new tab; if blocked, navigate.
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a.copilot-link');
      if (!a) return;
      e.preventDefault();
      const q = a.getAttribute('data-q') || '';
      const url = `https://www.bing.com/search?q=${q}&showconv=1`;

      // Persist UI state before leaving
      saveState();

      const w = window.open(url, '_blank', 'noopener,noreferrer');
      if (!w) {
        // Popup blocked: as a fallback, navigate current tab (state will restore on return/reload)
        window.location.href = url;
      }
    });

    window.onload = loadCSVFiles;
  </script>
</body>
</html>
